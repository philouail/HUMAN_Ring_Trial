---
title: "Object Creation for Lab Comparison Analysis"
format: html
execute:
  dir: project
---

# Introduction

This document creates all the data objects needed for the lab comparison analysis.
These objects are saved to the `object/` directory and can be loaded by other
analysis scripts.

## Load libraries

```{r library, include=TRUE, warning=FALSE, message=FALSE}
library(Chromatograms)
library(Spectra)
library(xcms)
library(MsIO)
library(MsExperiment)

base_path <- file.path("5_downstream_analysis")
source(file.path(base_path, "rt_analysis_function.R"))
```

```{r cores-cluster}
# cluster parallel setting
bpparam <- MulticoreParam(workers = parallel::detectCores() - 1)
```

# Full Data Objects

## Load Full Data

```{r load-full-data}
if (!file.exists(file.path(base_path, "object/sp_full.RData"))) {
  sp_afekta <- load_data(lab = "afekta", study_group = "HE")
  sp_hmgu <- load_data(lab = "hmgu", study_group = "HE")
  sp_icl <- load_data(lab = "icl", study_group = "HE")
  sp_cembio <- load_data(lab = "cembio", study_group = "HE")

  sp_full <- c(sp_afekta, sp_hmgu, sp_icl, sp_cembio)
  save(sp_full, file = file.path(base_path, "object/sp_full.RData"))
  rm(sp_afekta, sp_hmgu, sp_icl, sp_cembio)
} else {
  load(file.path(base_path, "object/sp_full.RData"))
}
```

## Create Base Peak Chromatogram (BPC) - Full Data

```{r load-bpc-full}
if(!file.exists(file.path(base_path, "object/bpc_full.RData"))) {
  bpc_full <- Chromatograms(sp_full, summarize.method = "max",
                       factorize.by= "dataOrigin",
                       spectraVariables = c("mixture", "lab"))
  bpc_full <- setBackend(bpc_full, ChromBackendMemory())
  save(file = file.path(base_path, "object/bpc_full.RData"), bpc_full)
} else {
  load(file.path(base_path, "object/bpc_full.RData"))
}
```

## Create Total Ion Current (TIC) - Full Data

```{r load-tic-full}
if (!file.exists(file.path(base_path, "object/tic_full.RData"))) {
  tic_full <- Chromatograms(sp_full, summarize.method = "sum",
                       factorize.by= "dataOrigin",
                       spectraVariables = c("mixture", "lab"))
  tic_full <- setBackend(tic_full, ChromBackendMemory())
  save(file = file.path(base_path, "object/tic_full.RData"), tic_full)
} else {
  load(file.path(base_path, "object/tic_full.RData"))
}
```

# Detected Signal Objects

## Load Detected Signal Data

```{r load-detect}
if (!file.exists(file.path(base_path, "object/sp_full_detect.RData"))) {
  bpparam <- MulticoreParam(8) # for the cluster
  sp_afekta <- detect_signal(lab = "afekta", study_group = "HE",
                             annotated = FALSE, bpparam = bpparam)
  save(sp_afekta, file = file.path(base_path, "object/sp_afekta.RData"))
  rm(sp_afekta)

  sp_hmgu <- detect_signal(lab = "hmgu", study_group = "HE",
                           annotated = FALSE, bpparam = bpparam)
  save(sp_hmgu, file = file.path(base_path, "object/sp_hmgu.RData"))
  rm(sp_hmgu)

  sp_icl <- detect_signal(lab = "icl", study_group = "HE",
                          annotated = FALSE, bpparam = bpparam)
  save(sp_icl, file = file.path(base_path, "object/sp_icl.RData"))
  rm(sp_icl)

  sp_cembio <- detect_signal(lab = "cembio", study_group = "HE",
                             annotated = FALSE, bpparam = bpparam)
  save(sp_cembio, file = file.path(base_path, "object/sp_cembio.RData"))

  load(file.path(base_path, "object/sp_hmgu.RData"))
  load(file.path(base_path, "object/sp_afekta.RData"))
  load(file.path(base_path, "object/sp_icl.RData"))

  sp_full_detect <- c(sp_afekta, sp_hmgu, sp_icl, sp_cembio)
  save(sp_full_detect, file = file.path(base_path, "object/sp_full_detect.RData"))
  rm(sp_afekta, sp_hmgu, sp_icl, sp_cembio)
} else {
  load(file.path(base_path, "object/sp_full_detect.RData"))
}
```

## Create Base Peak Chromatogram (BPC) - Detected Signal

```{r load-bpc-detect}
if (!file.exists(file.path(base_path, "object/bpc_detect.RData"))) {
  bpc_detect <- Chromatograms(sp_full_detect, summarize.method = "max",
                       factorize.by= "dataOrigin",
                       spectraVariables = c("lab", "mixture"))
  bpc_detect <- setBackend(bpc_detect, ChromBackendMemory())
  save(file = file.path(base_path, "object/bpc_detect.RData"), bpc_detect)
} else {
  load(file.path(base_path, "object/bpc_detect.RData"))
}
```

## Create Total Ion Current (TIC) - Detected Signal

```{r load-tic-detect}
if (!file.exists(file.path(base_path, "object/tic_detect.RData"))) {
  tic_detect <- Chromatograms(sp_full_detect, summarize.method = "sum",
                       factorize.by= "dataOrigin",
                       spectraVariables = c("mixture", "lab"))
  tic_detect <- setBackend(tic_detect, ChromBackendMemory())
  save(file = file.path(base_path, "object/tic_detect.RData"), tic_detect)
} else {
  load(file.path(base_path, "object/tic_detect.RData"))
}
```


# Annotated Signal Objects

## Load Annotations

```{r load-annotations}
study_group <- "HE"
res_afekta <- read.csv(file.path("4_library_generation", "afekta",
                                 study_group, "ring_trial_library_HE.csv"))
res_hmgu <- read.csv(file.path("4_library_generation", "hmgu",
                               study_group, "ring_trial_library_HE.csv"))
res_icl <- read.csv(file.path("4_library_generation", "icl",
                               study_group, "ring_trial_library_HE.csv"))
res_cembio <- read.csv(file.path("4_library_generation", "cembio",
                                 study_group, "ring_trial_library_HE.csv"))
```

## Load Annotated Signal Data

```{r an_signal_sp}
if (!file.exists(file.path(base_path, "object/sp_full_ann.RData"))) {
  bpparam <- MulticoreParam(8)
  sp_afekta <- detect_signal(lab = "afekta", study_group = study_group,
                             annotated = TRUE, bpparam = bpparam)
  sp_hmgu <- detect_signal(lab = "hmgu", study_group = study_group,
                           annotated = TRUE, bpparam = bpparam)
  sp_icl <- detect_signal(lab = "icl", study_group = study_group,
                          annotated = TRUE, bpparam = bpparam)
  sp_cembio <- detect_signal(lab = "cembio", study_group = study_group,
                             annotated = TRUE, bpparam = bpparam)
  sp_full_ann <- c(sp_afekta, sp_hmgu, sp_icl, sp_cembio)
  save(sp_full_ann, file = file.path(base_path, "object/sp_full_ann.RData"))
  rm(sp_afekta, sp_hmgu, sp_icl, sp_cembio)
} else {
  load(file.path(base_path, "object/sp_full_ann.RData"))
}
```

## Create Base Peak Chromatogram (BPC) - Annotated Signal

```{r load-bpc-ann}
if (!file.exists(file.path(base_path, "object/bpc_ann.RData"))) {
  bpc_ann <- Chromatograms(sp_full_ann, summarize.method = "max",
                       factorize.by= "dataOrigin",
                       spectraVariables = c("mixture", "lab"))
  bpc_ann <- setBackend(bpc_ann, ChromBackendMemory())
  save(file = file.path(base_path, "object/bpc_ann.RData"), bpc_ann)
} else {
  load(file.path(base_path, "object/bpc_ann.RData"))
}
```

## Create Total Ion Current (TIC) - Annotated Signal

```{r load-tic-ann}
if (!file.exists(file.path(base_path, "object/tic_ann.RData"))) {
  tic_ann <- Chromatograms(sp_full_ann, summarize.method = "sum",
                       factorize.by= "dataOrigin",
                       spectraVariables = c("mixture", "lab"))
  tic_ann <- setBackend(tic_ann, ChromBackendMemory())
  save(file = file.path(base_path, "object/tic_ann.RData"), tic_ann)
} else {
  load(file.path(base_path, "object/tic_ann.RData"))
}
```

# Peak Analysis Objects

## Load TIC Full Spectra

```{r load-tic-full-spectra}
if (!file.exists(file.path(base_path, "object/tic_full_spectra.RData"))) {
  load(file.path(base_path, "object/sp_full.RData"))
  sp_full <- filterEmptySpectra(sp_full)
  tic_full <- Chromatograms(sp_full, summarize.method = "sum",
                       factorize.by= "dataOrigin",
                       spectraVariables = c("mixture", "lab"))
  save(tic_full, file = file.path(base_path, "object/tic_full_spectra.RData"))
} else {
  load(file.path(base_path, "object/tic_full_spectra.RData"))
}
```


## Extract EICs for Detected Peaks

```{r peak-table-detected}
#' where can i extract the chrompeaks info
cpd_afekta <- read.csv(file.path(base_path, "detected_peaks_afekta_HE.csv"))
cpd_hmgu <- read.csv(file.path(base_path,"detected_peaks_hmgu_HE.csv"))
cpd_icl <- read.csv(file.path(base_path,  "detected_peaks_icl_HE.csv"))
cpd_cembio <- read.csv(file.path(base_path, "detected_peaks_cembio_HE.csv"))
cpd_afekta$lab <- "afekta"
cpd_hmgu$lab <- "hmgu"
cpd_icl$lab <- "icl"
cpd_cembio$lab <- "cembio"

peak_table_detect <- rbind(cpd_hmgu, cpd_afekta, cpd_icl, cpd_cembio)
colnames(peak_table_detect)[1] <- "chrom_peak_id"
colnames(peak_table_detect)[4:7] <- c("mzMin", "mzMax", "rtMin", "rtMax")
peak_table_detect$mzMin <- peak_table_detect$mzMin - 0.003
peak_table_detect$mzMax <- peak_table_detect$mzMax + 0.003
peak_table_detect$rtMin <- peak_table_detect$rtMin - 3
peak_table_detect$rtMax <- peak_table_detect$rtMax + 3
peak_table_detect$polarity <- ifelse(peak_table_detect$polarity == "pos", 1, 0)
```

```{r load-eics-detected}
if (!file.exists(file.path(base_path, "object/eics_detected.RData"))) {
  eics_detected <- chromExtract(
    tic_full,
    peak.table = peak_table_detect,
    by = c("polarity", "lab", "mixture")
  )
  eics_detected <- setBackend(eics_detected, ChromBackendMemory())
  eics_detected <- imputePeaksData(eics_detected, method = "linear")
  eics_detected <- applyProcessing(eics_detected)
  save(eics_detected, file = file.path(base_path, "object/eics_detected.RData"))
} else {
  load(file.path(base_path, "object/eics_detected.RData"))
}
```

## Extract EICs for annotated Peaks

```{r peak-table-annotated}
res_afekta$lab <- "afekta"
res_hmgu$lab <- "hmgu"
res_icl$lab <- "icl"
res_cembio$lab <- "cembio"

peak_table <- rbind(res_hmgu, res_afekta, res_icl, res_cembio)

colnames(peak_table)[1] <- "chrom_peak_id"
colnames(peak_table)[4:7] <- c("mzMin", "mzMax", "rtMin", "rtMax")
peak_table$mzMin <- peak_table$mzMin - 0.003
peak_table$mzMax <- peak_table$mzMax + 0.003
peak_table$rtMin <- peak_table$rtMin - 3
peak_table$rtMax <- peak_table$rtMax + 3
peak_table$polarity <- ifelse(peak_table$polarity == "pos", 1, 0)
```

```{r load-eics-ann, warning = FALSE}
if (!file.exists(file.path(base_path, "object/eics_ann.RData"))) {
  eics <- chromExtract(
    tic_full,
    peak.table = peak_table,
    by = c("polarity", "lab", "mixture")
  )
  eics <- setBackend(eics, ChromBackendMemory())
  eics <- imputePeaksData(eics, method = "linear")
  eics <- applyProcessing(eics)
  save(eics, file = file.path(base_path, "object/eics_ann.RData"))
} else {
  load(file.path(base_path, "object/eics_ann.RData"))
}
```

# Summary

All objects have been created and saved to the `object/` directory:

- `sp_full.RData`: Full spectra data from all labs
- `bpc_full.RData`: Base peak chromatograms (full data)
- `tic_full.RData`: Total ion chromatograms (full data)
- `sp_afekta.RData`, `sp_hmgu.RData`, `sp_icl.RData`, `sp_cembio.RData`: Individual lab detected signals
- `sp_full_detect.RData`: Combined detected signal data
- `bpc_detect.RData`: Base peak chromatograms (detected signal)
- `tic_detect.RData`: Total ion chromatograms (detected signal)
- `sp_full_ann.RData`: Annotated signal data
- `bpc_ann.RData`: Base peak chromatograms (annotated signal)
- `tic_ann.RData`: Total ion chromatograms (annotated signal)
- `tic_full_spectra.RData`: TIC from full spectra (for peak analysis)
- `eics_detected.RData`: Extracted ion chromatograms for detected peaks
- `eics_ann.RData`: Extracted ion chromatograms for annotated peaks
